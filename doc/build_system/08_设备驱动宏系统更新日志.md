# 设备驱动宏系统更新日志

**更新日期**: 2026-01-02

## 概述

本次更新实现了设备驱动的**双重宏系统**和**Device/config.h自动生成**，提供更强大、更灵活的设备管理能力。

## 主要变更

### 1. 设备驱动文件宏更新

将所有设备驱动文件中的条件编译宏从旧格式更新为 `USE_DEVICE_XXX` 格式。

#### 更新的设备驱动

| 设备 | 旧宏 | 新宏 | 文件数量 |
|------|------|------|---------|
| BMP280 | `#ifdef BMP280` | `#ifdef USE_DEVICE_BMP280` | 2 (.c, .h) |
| HMC588 | `#ifdef HMC5883L` | `#ifdef USE_DEVICE_HMC588` | 2 (.c, .h) |
| MPU6050 | `#ifdef MPU6050` | `#ifdef USE_DEVICE_MPU6050` | 1 (.c) |
| SH1106 | `#ifdef SH1106` | `#ifdef USE_DEVICE_SH1106` | 4 (.c, .h, fonts) |
| SSD1306 | `#ifdef SSD1306` | `#ifdef USE_DEVICE_SSD1306` | 4 (.c, .h, fonts) |
| ST7789 | 无 | `#ifdef USE_DEVICE_ST7789` | 2 (.c, .h) |

**总计**: 15个文件更新

#### 修改示例

**修改前：**
```c
// Device/bmp280/bmp280.c
#ifdef BMP280
#include "bmp280.h"
// ...
#endif /* BMP280 */
```

**修改后：**
```c
// Device/bmp280/bmp280.c
#ifdef USE_DEVICE_BMP280
#include "bmp280.h"
// ...
#endif /* USE_DEVICE_BMP280 */
```

### 2. 新增 config_generator.py 模块

创建了专门的配置生成器模块，负责自动生成 `Device/config.h` 文件。

**文件路径**: `tool/config_generator.py`

**主要功能**:
- ✅ 从 `project_config.json` 读取设备启用状态
- ✅ 生成旧格式宏定义（BMP280, MPU6050等）用于应用层
- ✅ 生成设备特定配置（I2C、延时等）
- ✅ 自动处理设备名称到宏名称的映射

**核心方法**:
```python
class ConfigGenerator:
    def generate_device_config_header(self) -> str:
        """生成Device/config.h头文件内容"""

    def write_config_header(self) -> None:
        """写入配置头文件"""
```

### 3. build.py 集成

将 `config_generator.py` 集成到主构建流程中。

**修改内容**:

```python
# 添加导入
from config_generator import ConfigGenerator

# 在build()方法中添加
def build(self, chip_name=None, board_name=None):
    # ... 生成CMakeLists.txt
    self.generate_bsp_device_cmake()

    # 生成Device/config.h  ← 新增
    self.generate_device_config_header()

    # ... 生成其他配置

# 新增方法
def generate_device_config_header(self):
    """生成Device/config.h配置文件"""
    config_gen = ConfigGenerator(self.project_root)
    config_gen.write_config_header()
```

### 4. Device/config.h 自动生成

现在 `Device/config.h` 完全由构建系统自动生成，无需手动维护。

**生成的内容包括**:

1. **文件头注释**
   ```c
   /**
    * @file    config.h
    * @brief   设备驱动配置文件 (自动生成)
    * @warning 此文件会在每次构建时重新生成，手动修改将会丢失
    */
   ```

2. **设备驱动宏定义**（旧格式，用于应用层）
   ```c
   #define BMP280               /* bmp280 驱动已启用 */
   #define HMC5883L             /* hmc588 驱动已启用 */
   #define MPU6050              /* mpu6050 驱动已启用 */
   #define SH1106               /* sh1106 驱动已启用 */
   ```

3. **I2C总线配置**
   ```c
   #define __SOFTI2C_
   #ifdef __SOFTI2C_
   #include <i2c/df_iic.h>
   extern SIAS i2c1_bus;
   #define i2c_Dev i2c1_bus
   #endif
   ```

4. **各设备特定配置**
   ```c
   #ifdef BMP280
   #include <i2c/df_iic.h>
   #define i2c_dev i2c1_bus
   #endif

   #ifdef MPU6050
   #include <df_delay.h>
   extern Dt delay;
   uint8_t mpu6050_i2c_write(...);
   uint8_t mpu6050_i2c_read(...);
   #endif
   ```

### 5. .gitignore 更新

将自动生成的 `Device/config.h` 添加到 `.gitignore`：

```gitignore
# 自动生成的文件
CMakeLists.txt
BSP/CMakeLists.txt
Device/CMakeLists.txt
Device/config.h          ← 新增
tool/project_config.json
idea.cfg
```

## 双重宏系统

### 系统架构

```
project_config.json
     ↓
┌────┴─────┐
↓          ↓
CMakeLists.txt    Device/config.h
(USE_DEVICE_XXX)   (BMP280, MPU6050等)
     ↓                 ↓
Device/*.c          app/*.c
(驱动源码)         (应用代码)
```

### 宏的用途分工

| 宏类型 | 定义位置 | 作用范围 | 用途 |
|--------|---------|---------|------|
| **USE_DEVICE_XXX** | CMakeLists.txt | 驱动层 | 保护驱动源文件条件编译 |
| **设备名宏** | Device/config.h | 应用层 | 应用代码功能判断 |

### 使用示例对比

**驱动层（USE_DEVICE_XXX）**:
```c
// Device/bmp280/bmp280.c
#ifdef USE_DEVICE_BMP280  // ← CMake定义，-DUSE_DEVICE_BMP280
#include "bmp280.h"

void BMP280_Init(void) {
    // 驱动实现
}

#endif // USE_DEVICE_BMP280
```

**应用层（设备名宏）**:
```c
// app/main.c
#include <config.h>

void sensors_init(void) {
#ifdef BMP280  // ← config.h定义，用于功能判断
    BMP280_Init();
    printf("BMP280 initialized\n");
#endif
}
```

## 工作流程

### 1. 配置设备

编辑 `tool/project_config.json`:

```json
{
  "devices": {
    "bmp280": {
      "enabled": true,   // ← 启用
      "sources": ["bmp280/bmp280.c"],
      "include_dirs": ["Device/bmp280"]
    },
    "ssd1306": {
      "enabled": false,  // ← 禁用
      "sources": ["ssd1306/fonts.c", "ssd1306/ssd1306.c"],
      "include_dirs": ["Device/ssd1306"]
    }
  }
}
```

### 2. 运行构建

```bash
python tool\build.py
```

**输出示例**:
```
使用配置: 4 个设备 (bmp280, hmc588, mpu6050, sh1106)，共 6 个源文件
已生成: Device\CMakeLists.txt
✓ 生成设备配置文件: Device/config.h
```

### 3. 自动生成文件

**CMakeLists.txt**:
```cmake
add_definitions(-DUSE_DEVICE_BMP280)
add_definitions(-DUSE_DEVICE_HMC588)
add_definitions(-DUSE_DEVICE_MPU6050)
add_definitions(-DUSE_DEVICE_SH1106)
# 没有 USE_DEVICE_SSD1306 - ssd1306已禁用
```

**Device/config.h**:
```c
#define BMP280               /* bmp280 驱动已启用 */
#define HMC5883L             /* hmc588 驱动已启用 */
#define MPU6050              /* mpu6050 驱动已启用 */
#define SH1106               /* sh1106 驱动已启用 */
// 没有 #define SSD1306 - ssd1306已禁用
```

**Device/CMakeLists.txt**:
```cmake
# 设备: bmp280 (宏: USE_DEVICE_BMP280)
set(BMP280_SOURCES bmp280/bmp280.c)

# 设备: mpu6050 (宏: USE_DEVICE_MPU6050)
set(MPU6050_SOURCES mpu6050/inv_mpu.c ...)

# 没有ssd1306相关内容 - 已禁用
```

### 4. 编译

```bash
cd build
ninja
```

**效果**:
- ✅ 已启用设备的驱动代码被编译
- ✅ 已禁用设备的驱动代码被完全排除
- ✅ 应用层可以通过宏判断设备是否可用

## 优势

### ✅ 1. 完全自动化

- 修改一个JSON配置文件
- 自动更新所有相关文件（CMakeLists.txt, config.h, Device/CMakeLists.txt）
- 无需手动维护宏定义

### ✅ 2. 双层保护

- **驱动层**: USE_DEVICE_XXX 确保禁用设备的代码不被编译
- **应用层**: 设备名宏提供简洁的功能判断

### ✅ 3. 向后兼容

- 保留原有宏名称（BMP280, MPU6050等）
- 应用代码无需大规模修改
- 平滑过渡到新系统

### ✅ 4. 集中管理

- 所有配置在 project_config.json
- config.h 自动生成，无人为错误
- 一目了然的设备状态

### ✅ 5. 灵活裁剪

- 启用/禁用设备立即生效
- 减少编译时间
- 减小固件体积

## 测试结果

### 启用4个设备

**配置**:
```json
{
  "bmp280": {"enabled": true, ...},
  "hmc588": {"enabled": true, ...},
  "mpu6050": {"enabled": true, ...},
  "sh1106": {"enabled": true, ...},
  "ssd1306": {"enabled": false, ...}
}
```

**输出**:
```
使用配置: 4 个设备 (bmp280, hmc588, mpu6050, sh1106)，共 6 个源文件
✓ 生成设备配置文件: Device/config.h
```

**生成的宏**:
- CMakeLists.txt: 4个 USE_DEVICE_XXX 宏
- Device/config.h: 4个设备名宏
- Device/CMakeLists.txt: 4组设备源文件

### 启用5个设备

**配置**:
```json
{
  "ssd1306": {"enabled": true, ...}  // 启用ssd1306
}
```

**输出**:
```
使用配置: 5 个设备 (bmp280, hmc588, mpu6050, sh1106, ssd1306)，共 8 个源文件
```

**效果**:
- 从6个源文件增加到8个（ssd1306有2个源文件）
- SSD1306宏被定义
- USE_DEVICE_SSD1306 被添加到CMakeLists.txt

## 文件清单

### 新增文件

1. **tool/config_generator.py** (347行)
   - Device/config.h生成器
   - 设备宏定义管理
   - 设备配置生成

2. **doc/build_system/07_Device_config_h自动生成说明.md**
   - 详细的使用文档
   - 双重宏系统说明
   - 完整示例

3. **doc/build_system/08_设备驱动宏系统更新日志.md** (本文件)
   - 更新总结
   - 变更清单

### 修改的文件

1. **tool/build.py**
   - 导入 ConfigGenerator
   - 添加 generate_device_config_header() 方法
   - 集成到构建流程

2. **Device/bmp280/** (2个文件)
   - bmp280.c: `#ifdef BMP280` → `#ifdef USE_DEVICE_BMP280`
   - bmp280.h: 同上

3. **Device/hmc588/** (2个文件)
   - hmc588.c: `#ifdef HMC5883L` → `#ifdef USE_DEVICE_HMC588`
   - hmc588.h: 同上

4. **Device/mpu6050/** (1个文件)
   - inv_mpu.c: `#ifdef MPU6050` → `#ifdef USE_DEVICE_MPU6050` (3处)

5. **Device/sh1106/** (4个文件)
   - sh1106.c, sh1106.h, fonts.c, fonts.h
   - `#ifdef SH1106` → `#ifdef USE_DEVICE_SH1106`

6. **Device/ssd1306/** (4个文件)
   - ssd1306.c, ssd1306.h, fonts.c, fonts.h
   - `#ifdef SSD1306` → `#ifdef USE_DEVICE_SSD1306`

7. **Device/st7789/** (2个文件)
   - st7789.c, st7789.h
   - 新增 `#ifdef USE_DEVICE_ST7789` 保护

8. **.gitignore**
   - 添加 `Device/config.h` 到忽略列表

### 自动生成的文件

1. **Device/config.h** (每次构建时生成)
   - 设备驱动宏定义
   - I2C总线配置
   - 设备特定配置

## 注意事项

### ⚠️ 不要手动编辑 Device/config.h

```c
/**
 * @warning 此文件会在每次构建时重新生成，手动修改将会丢失
 */
```

所有设备配置应在 `tool/project_config.json` 中修改。

### ⚠️ 设备名称映射

注意以下特殊映射关系：
- `hmc588` 目录 → `HMC5883L` 宏（历史原因，芯片实际型号）
- 其他设备：目录名的大写形式

### ⚠️ 应用代码适配

建议在应用代码中使用条件编译：

```c
// 推荐
void init_sensors(void) {
#ifdef BMP280
    BMP280_Init();
#endif
}

// 不推荐（如果BMP280被禁用会编译失败）
void bad_init(void) {
    BMP280_Init();  // 硬编码调用
}
```

## 后续计划

### 可能的改进

1. **宏名称统一**
   - 考虑将 HMC5883L 改为 HMC588 以保持一致性
   - 需要评估对现有代码的影响

2. **配置验证**
   - 添加配置文件语法检查
   - 检查设备依赖关系

3. **更多设备类型**
   - SPI设备配置生成
   - UART设备配置生成

4. **可视化配置界面**
   - Web界面或GUI工具
   - 图形化启用/禁用设备

## 总结

本次更新实现了：

✅ **统一的宏命名规范**: USE_DEVICE_XXX
✅ **自动化的配置管理**: Device/config.h自动生成
✅ **双重保护机制**: 驱动层和应用层分离
✅ **向后兼容**: 保留原有宏名称
✅ **集中式配置**: 通过JSON统一管理

这套系统让设备驱动管理更加**简单**、**安全**、**高效**！

---

**相关文档**:
- [06_设备驱动裁剪指南.md](06_设备驱动裁剪指南.md)
- [07_Device_config_h自动生成说明.md](07_Device_config_h自动生成说明.md)

**修改时间**: 2026-01-02
**版本**: v1.0
