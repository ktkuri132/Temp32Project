# 设备驱动裁剪指南

## 概述

项目支持通过 `project_config.json` 配置文件来灵活裁剪设备驱动，无需修改代码即可启用或禁用特定设备。

## 配置文件结构

### BSP配置

```json
"bsp": {
  "chip_dir": "stm32f4",
  "sources": [
    "stm32f4/CORE/startup_stm32f40_41xxx.c",
    "stm32f4/CORE/stm32f4xx_it.c",
    ...
  ],
  "include_dirs": [
    "BSP/CMSIS/Core/Include",
    "BSP/stm32f4/CORE",
    ...
  ]
}
```

- `chip_dir`: BSP芯片目录名
- `sources`: BSP源文件列表（相对于BSP目录）
- `include_dirs`: BSP头文件目录列表（相对于项目根目录）

### Device配置

```json
"devices": {
  "bmp280": {
    "enabled": true,
    "sources": ["bmp280/bmp280.c"],
    "include_dirs": ["Device/bmp280"]
  },
  "mpu6050": {
    "enabled": false,
    "sources": [
      "mpu6050/inv_mpu.c",
      "mpu6050/inv_mpu_dmp_motion_driver.c"
    ],
    "include_dirs": ["Device/mpu6050"]
  }
}
```

- `enabled`: 是否启用该设备驱动（true/false）
- `sources`: 设备源文件列表（相对于Device目录）
- `include_dirs`: 设备头文件目录列表（相对于项目根目录）

## 设备驱动开关

每个设备驱动都有对应的宏定义开关：

| 设备 | 宏定义 | 用途 |
|------|--------|------|
| bmp280 | `USE_DEVICE_BMP280` | 气压温度传感器 |
| hmc588 | `USE_DEVICE_HMC588` | 三轴磁力计 |
| mpu6050 | `USE_DEVICE_MPU6050` | 六轴IMU |
| sh1106 | `USE_DEVICE_SH1106` | OLED显示屏 |
| ssd1306 | `USE_DEVICE_SSD1306` | OLED显示屏 |
| st7789 | `USE_DEVICE_ST7789` | TFT LCD彩屏 |

### 在代码中使用

```c
#ifdef USE_DEVICE_BMP280
    #include "bmp280.h"
    bmp280_init();
#endif

#ifdef USE_DEVICE_MPU6050
    #include "inv_mpu.h"
    mpu_init();
#endif
```

## 使用方法

### 1. 初次扫描生成配置

```bash
# 删除现有配置
rm tool/project_config.json

# 重新运行构建脚本
python tool/build.py
```

这会自动扫描所有BSP和Device文件，并生成完整的配置文件。

### 2. 禁用某个设备

编辑 `tool/project_config.json`：

```json
"devices": {
  "mpu6050": {
    "enabled": false,  // 改为false禁用
    "sources": [...],
    "include_dirs": [...]
  }
}
```

### 3. 重新生成构建文件

```bash
python tool/build.py
```

不需要重新扫描，直接使用配置文件即可。

### 4. 编译项目

```bash
cd build
ninja
```

## 效果

### 启用设备时

**CMakeLists.txt**:
```cmake
add_definitions(-DUSE_DEVICE_BMP280)  # 启用bmp280设备驱动
```

**Device/CMakeLists.txt**:
```cmake
# 设备: bmp280 (宏: USE_DEVICE_BMP280)
set(BMP280_SOURCES
    bmp280/bmp280.c
)
```

**编译输出**:
```
-- 使用配置: 6 个设备 (bmp280, hmc588, mpu6050, sh1106, ssd1306, st7789)，共 9 个源文件
```

### 禁用设备时

**CMakeLists.txt**:
```cmake
# USE_DEVICE_BMP280 宏不会被定义
```

**Device/CMakeLists.txt**:
```cmake
# bmp280相关代码完全被排除
```

**编译输出**:
```
-- 使用配置: 5 个设备 (hmc588, mpu6050, sh1106, ssd1306, st7789)，共 7 个源文件
```

## 优势

### 1. 集中管理

所有BSP和Device配置都在一个地方管理，清晰明了。

### 2. 灵活裁剪

- 无需修改CMakeLists.txt
- 无需修改代码文件
- 只需修改JSON配置文件

### 3. 减小固件体积

禁用不需要的设备驱动可以：
- 减少编译时间
- 减小固件体积
- 降低RAM占用

### 4. 快速切换配置

可以为不同的硬件配置维护多个配置文件：

```bash
# 完整配置
cp tool/project_config.full.json tool/project_config.json

# 精简配置
cp tool/project_config.minimal.json tool/project_config.json

# 重新生成
python tool/build.py
```

## 注意事项

### 1. 依赖关系

如果应用代码中直接调用了设备驱动函数，需要添加条件编译：

```c
void init_sensors(void) {
#ifdef USE_DEVICE_BMP280
    bmp280_init();
#endif

#ifdef USE_DEVICE_MPU6050
    mpu_init();
#endif
}
```

### 2. 重新扫描

如果添加了新的设备驱动或BSP文件：

```bash
# 运行时选择重新扫描
python tool/build.py
# 输入 'y' 重新扫描
```

或者删除配置文件重新生成：

```bash
rm tool/project_config.json
python tool/build.py
```

### 3. 配置文件版本控制

建议将 `tool/project_config.json` 加入版本控制：
- 方便团队协作
- 记录配置变更历史
- 支持配置回滚

但构建生成的文件应忽略：
```gitignore
CMakeLists.txt
BSP/CMakeLists.txt
Device/CMakeLists.txt
```

## 示例场景

### 场景1: 开发调试版本

启用所有设备驱动，方便测试：

```json
"devices": {
  "bmp280": {"enabled": true, ...},
  "hmc588": {"enabled": true, ...},
  "mpu6050": {"enabled": true, ...},
  "sh1106": {"enabled": true, ...},
  "ssd1306": {"enabled": true, ...},
  "st7789": {"enabled": true, ...}
}
```

### 场景2: 生产发布版本

只启用实际使用的设备：

```json
"devices": {
  "bmp280": {"enabled": false, ...},
  "hmc588": {"enabled": false, ...},
  "mpu6050": {"enabled": true, ...},   // 仅保留IMU
  "sh1106": {"enabled": true, ...},    // 仅保留显示屏
  "ssd1306": {"enabled": false, ...},
  "st7789": {"enabled": false, ...}
}
```

结果：
- 固件体积减小约30%
- 编译时间缩短
- 不用的外设不会占用资源

### 场景3: 不同硬件版本

**硬件版本A** (使用OLED):
```json
"devices": {
  "sh1106": {"enabled": true, ...},
  "st7789": {"enabled": false, ...}
}
```

**硬件版本B** (使用TFT):
```json
"devices": {
  "sh1106": {"enabled": false, ...},
  "st7789": {"enabled": true, ...}
}
```

## 自动化脚本示例

### 切换配置脚本

```bash
#!/bin/bash
# switch_config.sh

case "$1" in
  full)
    cp configs/project_config.full.json tool/project_config.json
    ;;
  minimal)
    cp configs/project_config.minimal.json tool/project_config.json
    ;;
  production)
    cp configs/project_config.production.json tool/project_config.json
    ;;
  *)
    echo "Usage: $0 {full|minimal|production}"
    exit 1
    ;;
esac

python tool/build.py
cd build && ninja
```

### Python脚本示例

```python
#!/usr/bin/env python3
import json

# 读取配置
with open('tool/project_config.json', 'r', encoding='utf-8') as f:
    config = json.load(f)

# 禁用所有显示设备
for device_name in ['sh1106', 'ssd1306', 'st7789']:
    if device_name in config['devices']:
        config['devices'][device_name]['enabled'] = False

# 保存配置
with open('tool/project_config.json', 'w', encoding='utf-8') as f:
    json.dump(config, f, indent=2, ensure_ascii=False)

print("已禁用所有显示设备")
```

## 总结

通过 `project_config.json` 的集中配置管理：
- ✅ BSP源文件统一管理
- ✅ Device驱动统一管理
- ✅ 灵活的设备裁剪
- ✅ 自动生成宏定义
- ✅ 无需修改代码
- ✅ 支持快速配置切换

这套机制让项目可以轻松适应不同的硬件配置和应用场景！
