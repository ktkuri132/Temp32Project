# 项目构建脚本模块化说明

## 概述

build和download脚本已经重构为模块化设计，所有实现代码都已移至`tool`目录下，便于维护和扩展。

## 目录结构

```
tool/
├── build.py                    # 主构建脚本（新）
├── download.py                 # 下载脚本（已移动）
├── project_config.py           # 配置管理模块
├── source_scanner.py           # 源文件扫描和解析模块
├── cmake_generator.py          # CMakeLists生成模块
├── vscode_config_generator.py  # VS Code配置生成模块
└── project_config.json         # 项目配置文件

根目录/
└── build.py                    # 兼容性入口（引用tool/build.py）
```

## 模块说明

### 1. project_config.py - 配置管理模块
**功能：**
- 加载和保存项目配置JSON文件
- 提供配置的读取和设置接口
- 管理默认配置和用户配置的合并

**主要类：**
- `ProjectConfig`: 项目配置管理类

### 2. source_scanner.py - 源文件扫描和解析模块
**功能：**
- 扫描项目中的源文件（.c, .cpp, .s等）
- 扫描头文件目录
- 解析子目录的CMakeLists.txt
- 查找链接脚本文件
- 智能过滤BSP芯片目录

**主要类：**
- `SourceScanner`: 源文件扫描器

**主要方法：**
- `scan_sources()`: 扫描源文件
- `scan_include_dirs()`: 扫描头文件目录
- `analyze_cmake()`: 分析子目录CMakeLists.txt
- `find_linker_script()`: 查找链接脚本

### 3. cmake_generator.py - CMakeLists生成模块
**功能：**
- 生成CMakeLists.txt文件内容
- 读取CMake缓存获取工具链信息
- 配置编译标志和链接选项
- 支持多架构FPU配置

**主要类：**
- `CMakeGenerator`: CMakeLists.txt生成器

**主要方法：**
- `generate_cmake()`: 生成CMakeLists内容
- `read_cmake_cache()`: 读取CMake缓存
- `get_fpu_flags()`: 获取FPU配置标志

### 4. vscode_config_generator.py - VS Code配置生成模块
**功能：**
- 生成.vscode目录下的所有配置文件
  - c_cpp_properties.json
  - launch.json
  - tasks.json
  - settings.json
- 生成idea.cfg和.gitignore文件

**主要类：**
- `VscodeConfigGenerator`: VS Code配置生成器
- `AdditionalConfigGenerator`: 其他配置文件生成器

### 5. build.py - 主构建脚本
**功能：**
- 整合所有模块
- 协调项目配置、文件扫描、CMake生成等流程
- 提供命令行接口

**主要类：**
- `ProjectBuilder`: 项目构建器

**主要方法：**
- `build()`: 执行完整构建流程

## 使用方法

### 基本用法

从项目根目录运行（通过兼容性入口）：
```bash
python build.py
```

或直接运行tool目录下的脚本：
```bash
python tool/build.py
```

### 命令行参数

```bash
python build.py --chip STM32F407VE --board MyBoard
python build.py --dir /path/to/project
python build.py --force  # 强制覆盖
```

### 下载脚本

```bash
python tool/download.py
```

## 配置文件

项目配置保存在 `tool/project_config.json`，包含以下配置项：

- **project**: 项目基本信息（芯片型号、架构等）
- **toolchain**: 工具链配置
- **build**: 构建选项
- **linker**: 链接器配置
- **defines**: 宏定义
- **download**: 下载配置
- **files**: 文件列表（自动生成）

## 工作流程

1. **首次运行**：
   - 自动检测项目配置
   - 扫描源文件和头文件
   - 生成配置文件和CMakeLists.txt
   - 生成VS Code配置

2. **后续运行**：
   - 从配置文件读取设置
   - 根据配置生成CMakeLists.txt
   - 可选择重新扫描项目文件

3. **手动刷新**：
   - 运行时选择 'y' 重新扫描项目文件
   - 更新配置和文件列表

## 优势

1. **模块化设计**：每个模块职责单一，易于维护
2. **可扩展性**：新功能可以独立添加新模块
3. **配置驱动**：通过JSON配置文件管理项目设置
4. **智能检测**：自动检测芯片架构、链接脚本等
5. **兼容性**：保留根目录入口脚本，无需改变使用习惯

## 注意事项

- 首次运行后会生成 `tool/project_config.json`
- 修改配置请编辑JSON文件，然后重新运行脚本
- BSP目录会根据芯片型号自动过滤
- 工具链路径从CMake缓存自动读取
