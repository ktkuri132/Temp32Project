# æ„å»ºç³»ç»Ÿæ›´æ–°è¯´æ˜ - æ”¯æŒè‡ªå®šä¹‰é“¾æ¥å™¨è„šæœ¬

**æ›´æ–°æ—¥æœŸ**ï¼š2026-01-02
**åŠŸèƒ½**ï¼šæ”¯æŒåœ¨æ„å»ºç³»ç»Ÿä¸­ä½¿ç”¨è‡ªå®šä¹‰é“¾æ¥å™¨è„šæœ¬ï¼Œç‰¹åˆ«æ˜¯é©±åŠ¨æ¡†æ¶çš„è‡ªåŠ¨åˆå§‹åŒ–æ®µ

---

## âœ… å®Œæˆçš„ä¿®æ”¹

### 1. **ä¸»é“¾æ¥è„šæœ¬ä¿®æ”¹** âœ¨

**æ–‡ä»¶**ï¼š`BSP/stm32f4/CORE/stm32f4xx.ld`

åœ¨ `.rodata` æ®µä¸­æ·»åŠ äº†é©±åŠ¨æ¡†æ¶è‡ªåŠ¨åˆå§‹åŒ–æ®µï¼š

```ld
.rodata :
{
    . = ALIGN(4);
    *(.rodata)
    *(.rodata*)

    /* ===== é©±åŠ¨æ¡†æ¶è‡ªåŠ¨åˆå§‹åŒ–æ®µï¼ˆRT-Threadé£æ ¼ï¼‰===== */
    . = ALIGN(4);
    __df_init_fn_start = .;
    KEEP(*(.df_init_fn.0))    /* æ¿çº§åˆå§‹åŒ–ï¼ˆBOARDï¼‰ */
    KEEP(*(.df_init_fn.1))    /* å‰ç½®åˆå§‹åŒ–ï¼ˆPREVï¼‰ */
    KEEP(*(.df_init_fn.2))    /* è®¾å¤‡åˆå§‹åŒ–ï¼ˆDEVICEï¼‰ */
    KEEP(*(.df_init_fn.3))    /* ç»„ä»¶åˆå§‹åŒ–ï¼ˆCOMPONENTï¼‰ */
    KEEP(*(.df_init_fn.4))    /* ç¯å¢ƒåˆå§‹åŒ–ï¼ˆENVï¼‰ */
    KEEP(*(.df_init_fn.5))    /* åº”ç”¨åˆå§‹åŒ–ï¼ˆAPPï¼‰ */
    __df_init_fn_end = .;
    . = ALIGN(4);
} >FLASH
```

**ç‰¹ç‚¹**ï¼š
- âœ… å®šä¹‰äº†6ä¸ªåˆå§‹åŒ–çº§åˆ«ï¼ˆ0-5ï¼‰
- âœ… ä½¿ç”¨ `KEEP()` é˜²æ­¢é“¾æ¥å™¨ä¼˜åŒ–
- âœ… è‡ªåŠ¨æŒ‰å­—å…¸åºæ’åºæ‰§è¡Œ
- âœ… æä¾›æ®µè¾¹ç•Œç¬¦å· `__df_init_fn_start` å’Œ `__df_init_fn_end`

---

### 2. **æ„å»ºè„šæœ¬å¢å¼º** ğŸ› ï¸

#### æ–‡ä»¶ï¼š`tool/cmake_generator.py`

**æ–°å¢åŠŸèƒ½**ï¼š
1. æ”¯æŒé¢å¤–çš„é“¾æ¥å™¨è„šæœ¬åˆ—è¡¨
2. è‡ªåŠ¨ç”Ÿæˆå¤šä¸ª `-T` é“¾æ¥å™¨å‚æ•°
3. åœ¨è¾“å‡ºä¸­æ˜¾ç¤ºé¢å¤–è„šæœ¬ä¿¡æ¯

**å…³é”®ä»£ç **ï¼š
```python
# æ„å»ºé¢å¤–çš„é“¾æ¥å™¨è„šæœ¬å‚æ•°
additional_scripts = self.config.get('linker.additional_scripts', [])
additional_script_flags = ' '.join([f'-T${{CMAKE_SOURCE_DIR}}/{script}'
                                    for script in additional_scripts])
```

**ç”Ÿæˆçš„CMakeå‘½ä»¤**ï¼š
```cmake
set(CMAKE_EXE_LINKER_FLAGS "... -T${CMAKE_SOURCE_DIR}/BSP/stm32f4/CORE/stm32f4xx.ld -T${CMAKE_SOURCE_DIR}/Driver_Framework/linker/df_init_gcc.ld ...")
```

---

### 3. **é…ç½®æ–‡ä»¶æ‰©å±•** âš™ï¸

**æ–‡ä»¶**ï¼š`tool/project_config.json`

æ–°å¢ `linker.additional_scripts` é…ç½®é¡¹ï¼š

```json
{
  "linker": {
    "script": "BSP/stm32f4/CORE/stm32f4xx.ld",
    "additional_scripts": [],  // æ–°å¢ï¼šé¢å¤–çš„é“¾æ¥å™¨è„šæœ¬åˆ—è¡¨
    "specs": ["nosys.specs", "nano.specs"],
    ...
  }
}
```

**ä½¿ç”¨æ–¹å¼**ï¼š
```json
{
  "linker": {
    "script": "BSP/stm32f4/CORE/stm32f4xx.ld",
    "additional_scripts": [
      "Driver_Framework/linker/df_init_gcc.ld",
      "path/to/another_script.ld"
    ]
  }
}
```

---

### 4. **æµ‹è¯•æ–‡ä»¶åˆ›å»º** ğŸ§ª

**æ–‡ä»¶**ï¼š`app/test_df_init.c`

åˆ›å»ºäº†å®Œæ•´çš„åˆå§‹åŒ–æµ‹è¯•ç¤ºä¾‹ï¼š

```c
#include "df_init.h"

// å„çº§åˆå§‹åŒ–å‡½æ•°
static int test_board_init(void) {
    printf("[BOARD] Board initialization\n");
    return 0;
}
DF_BOARD_INIT(test_board_init);

static int test_device_init(void) {
    printf("[DEVICE] Device initialization\n");
    return 0;
}
DF_DEVICE_INIT(test_device_init);

// ... å…¶ä»–çº§åˆ«

// å¯ç”¨è‡ªåŠ¨åˆå§‹åŒ–
DF_INIT_AUTO_ENABLE();
```

---

## ğŸ¯ ä½¿ç”¨æ–¹æ³•

### æ–¹å¼1ï¼šç›´æ¥ä½¿ç”¨ï¼ˆæ¨èï¼‰âœ…

ç”±äºåˆå§‹åŒ–æ®µå·²é›†æˆåˆ°ä¸»é“¾æ¥è„šæœ¬ï¼Œ**æ— éœ€ä»»ä½•é¢å¤–é…ç½®**ã€‚

#### æ­¥éª¤1ï¼šæ³¨å†Œåˆå§‹åŒ–å‡½æ•°

åœ¨ä»»æ„ `.c` æ–‡ä»¶ä¸­ï¼š

```c
#include "df_init.h"

static int my_module_init(void)
{
    // æ¨¡å—åˆå§‹åŒ–ä»£ç 
    return 0;
}
DF_DEVICE_INIT(my_module_init);
```

#### æ­¥éª¤2ï¼šå¯ç”¨è‡ªåŠ¨åˆå§‹åŒ–

åœ¨æŸä¸ªæºæ–‡ä»¶ï¼ˆå¦‚ `main.c`ï¼‰ä¸­ï¼š

```c
DF_INIT_AUTO_ENABLE();
```

#### æ­¥éª¤3ï¼šé‡æ–°ç¼–è¯‘

```bash
python tool/build.py
cd build
ninja  # æˆ– make
```

---

### æ–¹å¼2ï¼šä½¿ç”¨é¢å¤–è„šæœ¬ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦ä¿æŒä¸»è„šæœ¬ä¸å˜ï¼Œä½¿ç”¨é¢å¤–è„šæœ¬ã€‚

#### æ­¥éª¤1ï¼šä¿®æ”¹é…ç½®

ç¼–è¾‘ `tool/project_config.json`ï¼š

```json
{
  "linker": {
    "script": "BSP/stm32f4/CORE/stm32f4xx.ld",
    "additional_scripts": [
      "Driver_Framework/linker/df_init_gcc.ld"
    ]
  }
}
```

#### æ­¥éª¤2ï¼šé‡æ–°ç”Ÿæˆæ„å»ºæ–‡ä»¶

```bash
python tool/build.py
```

#### æ­¥éª¤3ï¼šéªŒè¯

æ£€æŸ¥ç”Ÿæˆçš„ `CMakeLists.txt`ï¼š

```cmake
set(CMAKE_EXE_LINKER_FLAGS "... -T${CMAKE_SOURCE_DIR}/BSP/stm32f4/CORE/stm32f4xx.ld -T${CMAKE_SOURCE_DIR}/Driver_Framework/linker/df_init_gcc.ld ...")
```

---

## ğŸ“Š éªŒè¯æ–¹æ³•

### 1. æ£€æŸ¥ç”Ÿæˆçš„ CMakeLists.txt

```bash
cat CMakeLists.txt | grep LINKER_FLAGS
```

åº”è¯¥çœ‹åˆ°ï¼š
```cmake
set(CMAKE_EXE_LINKER_FLAGS "-mcpu=cortex-m4 ... -T${CMAKE_SOURCE_DIR}/BSP/stm32f4/CORE/stm32f4xx.ld ...")
```

### 2. æŸ¥çœ‹ Map æ–‡ä»¶

ç¼–è¯‘åæ£€æŸ¥ `build/32_temp_project.map`ï¼š

```bash
cat build/32_temp_project.map | grep df_init
```

åº”è¯¥çœ‹åˆ°ï¼š
```
__df_init_fn_start = 0x08001234
.df_init_fn.0      0x08001234   0x4
.df_init_fn.1      0x08001238   0x4
...
__df_init_fn_end   = 0x08001240
```

### 3. è¿è¡Œæµ‹è¯•

çƒ§å½•ç¨‹åºåï¼Œåº”è¯¥çœ‹åˆ°åˆå§‹åŒ–è¾“å‡ºï¼š

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Driver Framework Initialization      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[BOARD] Board initialization
[PREV] Pre-device initialization
[DEVICE] Device initialization
[COMPONENT] Component initialization
[ENV] Environment initialization
[APP] Application initialization
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[DF_INIT] 6 components initialized
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ”„ æ„å»ºæµç¨‹

```mermaid
graph TD
    A[é¡¹ç›®æºç ] --> B[tool/build.py]
    B --> C[æ‰«ææºæ–‡ä»¶]
    C --> D[project_config.json]
    D --> E[cmake_generator.py]
    E --> F[ç”Ÿæˆ CMakeLists.txt]
    F --> G[CMakeé…ç½®]
    G --> H[Ninja/Makeç¼–è¯‘]
    H --> I[ç”Ÿæˆ .elf/.hex/.bin]

    J[stm32f4xx.ld] --> G
    K[additional scripts] -.å¯é€‰.-> G
```

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
- âœ… `Driver_Framework/linker/df_init_gcc.ld` - GCCé“¾æ¥è„šæœ¬ç‰‡æ®µ
- âœ… `Driver_Framework/linker/df_init_keil.sct` - Keilåˆ†æ•£åŠ è½½æ–‡ä»¶ç‰‡æ®µ
- âœ… `Driver_Framework/linker/df_init_iar.icf` - IARé“¾æ¥é…ç½®ç‰‡æ®µ
- âœ… `Driver_Framework/linker/README.md` - é“¾æ¥å™¨é…ç½®è¯¦ç»†è¯´æ˜
- âœ… `Driver_Framework/linker/æ„å»ºé…ç½®è¯´æ˜.md` - æœ¬æ–‡æ¡£
- âœ… `Driver_Framework/linker/df_init_usage_example.c` - ä½¿ç”¨ç¤ºä¾‹
- âœ… `app/test_df_init.c` - æµ‹è¯•æ–‡ä»¶

### ä¿®æ”¹æ–‡ä»¶
- ğŸ”§ `BSP/stm32f4/CORE/stm32f4xx.ld` - æ·»åŠ åˆå§‹åŒ–æ®µ
- ğŸ”§ `tool/cmake_generator.py` - æ”¯æŒé¢å¤–é“¾æ¥è„šæœ¬
- ğŸ”§ `tool/project_config.json` - æ·»åŠ é…ç½®é¡¹

### æ ¸å¿ƒæ–‡ä»¶
- ğŸ“„ `Driver_Framework/df_init.h` - åˆå§‹åŒ–ç³»ç»Ÿå¤´æ–‡ä»¶
- ğŸ“„ `Driver_Framework/df_init.c` - åˆå§‹åŒ–ç³»ç»Ÿå®ç°

---

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šé“¾æ¥æ—¶æç¤º "undefined reference to '__df_init_fn_start'"

**åŸå› **ï¼šé“¾æ¥å™¨è„šæœ¬ä¸­æœªå®šä¹‰åˆå§‹åŒ–æ®µ

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥é“¾æ¥è„šæœ¬
cat BSP/stm32f4/CORE/stm32f4xx.ld | grep df_init

# åº”è¯¥çœ‹åˆ°æ®µå®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™éœ€è¦é‡æ–°æ·»åŠ 
```

### é—®é¢˜2ï¼šæ„å»ºè„šæœ¬è¿è¡Œå¤±è´¥

**åŸå› **ï¼šå¯èƒ½æ˜¯è¯­æ³•é”™è¯¯æˆ–é…ç½®é”™è¯¯

**è§£å†³**ï¼š
```bash
# æŸ¥çœ‹é”™è¯¯ä¿¡æ¯
python tool/build.py

# å¦‚æœæ˜¯é…ç½®æ–‡ä»¶é”™è¯¯ï¼Œå¯ä»¥åˆ é™¤é‡æ–°ç”Ÿæˆ
rm tool/project_config.json
python tool/build.py
```

### é—®é¢˜3ï¼šåˆå§‹åŒ–å‡½æ•°æ²¡æœ‰æ‰§è¡Œ

**åŸå› **ï¼š
- æœªè°ƒç”¨ `DF_INIT_AUTO_ENABLE()`
- æ®µè¢«ä¼˜åŒ–æ‰
- å‡½æ•°è¿”å›é0å€¼

**è§£å†³**ï¼š
```c
// 1. ç¡®ä¿è°ƒç”¨äº†è‡ªåŠ¨åˆå§‹åŒ–
DF_INIT_AUTO_ENABLE();

// 2. æ·»åŠ è°ƒè¯•è¾“å‡º
extern df_init_fn_t __df_init_fn_start;
extern df_init_fn_t __df_init_fn_end;
printf("Init section: %p to %p\n", &__df_init_fn_start, &__df_init_fn_end);

// 3. æ£€æŸ¥Mapæ–‡ä»¶
// cat build/32_temp_project.map | grep df_init
```

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| [df_init.h](../df_init.h) | åˆå§‹åŒ–ç³»ç»ŸAPIæ–‡æ¡£ |
| [df_init.c](../df_init.c) | åˆå§‹åŒ–ç³»ç»Ÿå®ç° |
| [linker/README.md](README.md) | é“¾æ¥å™¨è„šæœ¬è¯¦ç»†é…ç½® |
| [ä½¿ç”¨ç¤ºä¾‹.md](../ä½¿ç”¨ç¤ºä¾‹.md) | æ¡†æ¶å®Œæ•´ä½¿ç”¨ç¤ºä¾‹ |

---

## âœ… å¿«é€Ÿæµ‹è¯•

```bash
# 1. é‡æ–°ç”Ÿæˆæ„å»ºæ–‡ä»¶
echo y | python tool/build.py

# 2. æŸ¥çœ‹ç”Ÿæˆçš„CMakeLists.txt
cat CMakeLists.txt | grep LINKER_FLAGS

# 3. ç¼–è¯‘ï¼ˆéœ€è¦CMakeå’Œå·¥å…·é“¾ï¼‰
# cd build
# cmake ..
# ninja

# 4. æŸ¥çœ‹Mapæ–‡ä»¶
# cat build/32_temp_project.map | grep df_init
```

---

## ğŸ‰ æ€»ç»“

ç°åœ¨ä½ çš„æ„å»ºç³»ç»Ÿå·²ç»å®Œå…¨æ”¯æŒï¼š

1. âœ… **ä¸»é“¾æ¥è„šæœ¬é›†æˆ** - åˆå§‹åŒ–æ®µå·²æ·»åŠ åˆ° `stm32f4xx.ld`
2. âœ… **é¢å¤–è„šæœ¬æ”¯æŒ** - å¯é…ç½®å¤šä¸ªé“¾æ¥å™¨è„šæœ¬
3. âœ… **è‡ªåŠ¨åˆå§‹åŒ–** - GCCæ”¯æŒ constructor è‡ªåŠ¨è°ƒç”¨
4. âœ… **çµæ´»é…ç½®** - é€šè¿‡ `project_config.json` ç®¡ç†
5. âœ… **å®Œæ•´æµ‹è¯•** - æä¾›æµ‹è¯•æ–‡ä»¶å’ŒéªŒè¯æ–¹æ³•

**æ¨èä½¿ç”¨æ–¹å¼**ï¼šç›´æ¥ä½¿ç”¨ä¸»é“¾æ¥è„šæœ¬ï¼ˆå·²é›†æˆåˆå§‹åŒ–æ®µï¼‰ï¼Œæ— éœ€é¢å¤–é…ç½®ï¼

---

**ç»´æŠ¤è€…**ï¼šktkuri
**æ›´æ–°æ—¥æœŸ**ï¼š2026-01-02
