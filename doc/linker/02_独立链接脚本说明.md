# 使用独立链接脚本添加初始化段

## 方案说明

为了不修改硬件原始的链接脚本文件，框架的初始化段定义被放在一个独立的链接脚本中，通过 CMake 编译规则添加到链接过程中。

## 文件结构

```
Driver_Framework/linker/
├── df_init_sections.ld        # 独立的初始化段定义（✅ 使用此文件）
├── df_init_gcc.ld              # 原示例文件（仅供参考）
└── README.md                   # 详细文档
```

## 配置方式

### 1. 链接脚本定义

**文件**: `Driver_Framework/linker/df_init_sections.ld`

```ld
SECTIONS
{
    .df_init : ALIGN(4)
    {
        PROVIDE(__df_init_fn_start = .);
        KEEP(*(.df_init_fn.0))    /* BOARD */
        KEEP(*(.df_init_fn.1))    /* PREV */
        KEEP(*(.df_init_fn.2))    /* DEVICE */
        KEEP(*(.df_init_fn.3))    /* COMPONENT */
        KEEP(*(.df_init_fn.4))    /* ENV */
        KEEP(*(.df_init_fn.5))    /* APP */
        PROVIDE(__df_init_fn_end = .);
    } >FLASH
}
```

### 2. CMake 配置

**文件**: `tool/project_config.json`

```json
{
  "linker": {
    "script": "BSP/stm32f4/CORE/stm32f4xx.ld",
    "additional_scripts": [
      "Driver_Framework/linker/df_init_sections.ld"
    ]
  }
}
```

### 3. 生成的链接命令

CMake 会自动生成多个 `-T` 参数：

```bash
arm-none-eabi-gcc \
  -T BSP/stm32f4/CORE/stm32f4xx.ld \
  -T Driver_Framework/linker/df_init_sections.ld \
  ...
```

## 工作原理

1. **主链接脚本** (`stm32f4xx.ld`): 保持原始状态，定义 FLASH、RAM 等内存区域和基本段
2. **额外链接脚本** (`df_init_sections.ld`): 定义独立的 `.df_init` 段存储框架初始化函数指针
3. **GCC 链接器**: 自动合并多个链接脚本，将 `.df_init` 段放置在 FLASH 中

## 验证结果

### 内存分配

```
内存区域                地址            大小
.df_init               0x08007650      0x20 (32字节)
├── .df_init_fn.0      0x08007650      0x4  (df_log_auto_init)
├── .df_init_fn.0      0x08007654      0x4  (test_board_init)
├── .df_init_fn.1      0x08007658      0x4  (df_device_frame_auto_init)
├── .df_init_fn.1      0x0800765c      0x4  (df_irq_auto_init)
├── .df_init_fn.2      0x08007660      0x4  (test_device_init)
├── .df_init_fn.2      0x08007664      0x4  (df_iic_auto_init)
├── .df_init_fn.3      0x08007668      0x4  (df_display_auto_init)
└── .df_init_fn.5      0x0800766c      0x4  (test_app_init)
```

### 初始化符号

```
__df_init_fn_start = 0x08007650  // 起始地址
__df_init_fn_end   = 0x08007670  // 结束地址
```

## 优势

✅ **不修改硬件链接脚本**: `stm32f4xx.ld` 保持原始状态，方便升级
✅ **框架独立管理**: 初始化段定义独立在框架目录中
✅ **易于维护**: 添加/删除框架功能只需修改框架自己的链接脚本
✅ **兼容性好**: 适用于不同的硬件平台，只需调整 `>FLASH` 即可
✅ **自动化**: 通过 `project_config.json` 集中管理，CMake 自动生成命令

## 添加新的链接脚本

如果需要添加其他独立的链接脚本（如 FreeRTOS、lwIP 等），只需在配置文件中添加：

```json
{
  "linker": {
    "additional_scripts": [
      "Driver_Framework/linker/df_init_sections.ld",
      "RTOS/freertos_heap.ld",
      "Network/lwip_sections.ld"
    ]
  }
}
```

## 注意事项

1. **内存区域名称**: 额外链接脚本中的 `>FLASH` 必须与主链接脚本中定义的内存区域名称匹配
2. **链接顺序**: 额外链接脚本必须在主链接脚本之后指定（CMake 已自动处理）
3. **重新生成**: 修改 `project_config.json` 后需要运行 `python tool/build.py` 重新生成 CMakeLists.txt
