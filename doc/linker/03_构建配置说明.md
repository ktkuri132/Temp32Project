# é“¾æ¥å™¨è„šæœ¬é…ç½®è¯´æ˜

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•åœ¨é¡¹ç›®ä¸­ä½¿ç”¨è‡ªå®šä¹‰é“¾æ¥å™¨è„šæœ¬ï¼Œç‰¹åˆ«æ˜¯é©±åŠ¨æ¡†æ¶çš„è‡ªåŠ¨åˆå§‹åŒ–æ®µã€‚

---

## ğŸ“‹ é…ç½®æ–¹å¼

### æ–¹å¼1ï¼šç›´æ¥ä¿®æ”¹ä¸»é“¾æ¥è„šæœ¬ï¼ˆå·²å®Œæˆï¼‰âœ…

é©±åŠ¨æ¡†æ¶åˆå§‹åŒ–æ®µå·²ç»æ·»åŠ åˆ°ä¸»é“¾æ¥è„šæœ¬ `BSP/stm32f4/CORE/stm32f4xx.ld` ä¸­ã€‚

```ld
.rodata :
{
    . = ALIGN(4);
    *(.rodata)
    *(.rodata*)

    /* ===== é©±åŠ¨æ¡†æ¶è‡ªåŠ¨åˆå§‹åŒ–æ®µ ===== */
    . = ALIGN(4);
    __df_init_fn_start = .;
    KEEP(*(.df_init_fn.0))    /* æ¿çº§åˆå§‹åŒ– */
    KEEP(*(.df_init_fn.1))    /* å‰ç½®åˆå§‹åŒ– */
    KEEP(*(.df_init_fn.2))    /* è®¾å¤‡åˆå§‹åŒ– */
    KEEP(*(.df_init_fn.3))    /* ç»„ä»¶åˆå§‹åŒ– */
    KEEP(*(.df_init_fn.4))    /* ç¯å¢ƒåˆå§‹åŒ– */
    KEEP(*(.df_init_fn.5))    /* åº”ç”¨åˆå§‹åŒ– */
    __df_init_fn_end = .;
    . = ALIGN(4);
} >FLASH
```

**ä¼˜ç‚¹**ï¼šç®€å•ç›´æ¥ï¼Œå·²é›†æˆåˆ°ä¸»è„šæœ¬ä¸­
**é€‚ç”¨**ï¼šæ¨èä½¿ç”¨æ­¤æ–¹å¼

---

### æ–¹å¼2ï¼šä½¿ç”¨é¢å¤–é“¾æ¥è„šæœ¬ï¼ˆå¯é€‰ï¼‰

å¦‚æœæƒ³ä¿æŒä¸»é“¾æ¥è„šæœ¬ä¸å˜ï¼Œå¯ä»¥ä½¿ç”¨é¢å¤–çš„é“¾æ¥è„šæœ¬ã€‚

#### æ­¥éª¤1ï¼šä¿®æ”¹ `tool/project_config.json`

```json
{
  "linker": {
    "script": "BSP/stm32f4/CORE/stm32f4xx.ld",
    "additional_scripts": [
      "Driver_Framework/linker/df_init_gcc.ld"
    ],
    ...
  }
}
```

#### æ­¥éª¤2ï¼šè¿è¡Œæ„å»ºè„šæœ¬

```bash
python tool/build.py
# æˆ–
python build.py
```

#### æ­¥éª¤3ï¼šéªŒè¯ç”Ÿæˆçš„ CMakeLists.txt

æ£€æŸ¥ `CMakeLists.txt` ä¸­çš„é“¾æ¥å™¨æ ‡å¿—ï¼š

```cmake
set(CMAKE_EXE_LINKER_FLAGS "... -T${CMAKE_SOURCE_DIR}/BSP/stm32f4/CORE/stm32f4xx.ld -T${CMAKE_SOURCE_DIR}/Driver_Framework/linker/df_init_gcc.ld ...")
```

**ä¼˜ç‚¹**ï¼šä¸»é“¾æ¥è„šæœ¬ä¿æŒä¸å˜ï¼Œä¾¿äºç»´æŠ¤
**ç¼ºç‚¹**ï¼šéœ€è¦ç¡®ä¿ä¸¤ä¸ªè„šæœ¬ä¸å†²çª

---

## ğŸ¯ å½“å‰æ¨èæ–¹æ¡ˆ

ç”±äºé©±åŠ¨æ¡†æ¶åˆå§‹åŒ–æ®µå·²ç»é›†æˆåˆ°ä¸»é“¾æ¥è„šæœ¬ `stm32f4xx.ld` ä¸­ï¼Œ**æ— éœ€é¢å¤–é…ç½®**å³å¯ä½¿ç”¨ã€‚

### ä½¿ç”¨ç¤ºä¾‹

```c
#include "df_init.h"

// æ³¨å†Œåˆå§‹åŒ–å‡½æ•°
static int log_system_init(void)
{
    log_init(LOG_LEVEL_INFO);
    return 0;
}
DF_BOARD_INIT(log_system_init);

// GCC è‡ªåŠ¨åˆå§‹åŒ–
DF_INIT_AUTO_ENABLE();

int main(void)
{
    // æ¡†æ¶å·²è‡ªåŠ¨åˆå§‹åŒ–
    printf("System ready\n");
}
```

---

## ğŸ”§ ç¼–è¯‘å’Œæ„å»º

### 1. é‡æ–°ç”Ÿæˆæ„å»ºæ–‡ä»¶

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ
python tool/build.py

# æˆ–ä½¿ç”¨ç®€åŒ–å‘½ä»¤
python build.py
```

### 2. ç¼–è¯‘é¡¹ç›®

```bash
cd build
ninja
# æˆ–
make
```

### 3. æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶

æ£€æŸ¥ `build/` ç›®å½•ä¸‹çš„ï¼š
- `32_temp_project.elf` - å¯æ‰§è¡Œæ–‡ä»¶
- `32_temp_project.hex` - Intel HEX æ ¼å¼
- `32_temp_project.bin` - äºŒè¿›åˆ¶æ ¼å¼
- `32_temp_project.map` - å†…å­˜æ˜ å°„æ–‡ä»¶

---

## ğŸ“Š éªŒè¯åˆå§‹åŒ–æ®µ

### 1. æŸ¥çœ‹ Map æ–‡ä»¶

æ‰“å¼€ `build/32_temp_project.map`ï¼Œæœç´¢ `__df_init_fn_start`ï¼š

```
__df_init_fn_start = 0x08001234
.df_init_fn.0      0x08001234   0x4  app/main.o
.df_init_fn.1      0x08001238   0x4  Driver_Framework/df_iic.o
.df_init_fn.2      0x0800123c   0x4  Driver_Framework/df_uart.o
__df_init_fn_end   = 0x08001240
```

### 2. ä½¿ç”¨ objdump æŸ¥çœ‹æ®µä¿¡æ¯

```bash
arm-none-eabi-objdump -h build/32_temp_project.elf | grep df_init
```

### 3. ä½¿ç”¨ nm æŸ¥çœ‹ç¬¦å·

```bash
arm-none-eabi-nm build/32_temp_project.elf | grep df_init
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
08001234 R __df_init_fn_start
08001240 R __df_init_fn_end
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: é“¾æ¥æ—¶æç¤º "undefined reference to '__df_init_fn_start'"

**åŸå› **ï¼šé“¾æ¥å™¨è„šæœ¬ä¸­æœªå®šä¹‰åˆå§‹åŒ–æ®µ

**è§£å†³**ï¼š
1. ç¡®è®¤ `stm32f4xx.ld` ä¸­å·²æ·»åŠ åˆå§‹åŒ–æ®µå®šä¹‰
2. é‡æ–°è¿è¡Œæ„å»ºè„šæœ¬ç”Ÿæˆ CMakeLists.txt
3. æ¸…ç†å¹¶é‡æ–°ç¼–è¯‘ï¼š`rm -rf build && python build.py`

### Q2: åˆå§‹åŒ–å‡½æ•°æ²¡æœ‰è¢«è°ƒç”¨

**å¯èƒ½åŸå› **ï¼š
1. æœªè°ƒç”¨ `DF_INIT_AUTO_ENABLE()` æˆ– `DF_Framework_Init()`
2. æ®µè¢«é“¾æ¥å™¨ä¼˜åŒ–æ‰äº†ï¼ˆç¼ºå°‘ KEEP()ï¼‰
3. å‡½æ•°æŒ‡é’ˆä¸ºç©º

**è°ƒè¯•æ–¹æ³•**ï¼š
```c
// åœ¨ main å¼€å§‹å¤„æ‰“å°æ®µåœ°å€
extern df_init_fn_t __df_init_fn_start;
extern df_init_fn_t __df_init_fn_end;
printf("Init section: %p to %p\n", &__df_init_fn_start, &__df_init_fn_end);
```

### Q3: å¤šä¸ªé“¾æ¥è„šæœ¬å†²çª

**ç—‡çŠ¶**ï¼šé“¾æ¥æ—¶å‡ºç°é‡å¤å®šä¹‰æˆ–æ®µåœ°å€å†²çª

**è§£å†³**ï¼š
- ä½¿ç”¨æ–¹å¼1ï¼ˆç›´æ¥ä¿®æ”¹ä¸»è„šæœ¬ï¼Œæ¨èï¼‰
- æˆ–ç¡®ä¿é¢å¤–è„šæœ¬åªå®šä¹‰æ–°çš„æ®µï¼Œä¸é‡å¤å®šä¹‰ç°æœ‰æ®µ

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [df_init.h](../df_init.h) - æ¡†æ¶åˆå§‹åŒ–ç³»ç»Ÿå¤´æ–‡ä»¶
- [df_init.c](../df_init.c) - æ¡†æ¶åˆå§‹åŒ–ç³»ç»Ÿå®ç°
- [linker/README.md](README.md) - é“¾æ¥å™¨è„šæœ¬è¯¦ç»†è¯´æ˜
- [ä½¿ç”¨ç¤ºä¾‹.md](../ä½¿ç”¨ç¤ºä¾‹.md) - æ¡†æ¶ä½¿ç”¨ç¤ºä¾‹

---

## ğŸ”„ æ„å»ºæµç¨‹

```
project_config.json
       â†“
   [build.py]
       â†“
 cmake_generator.py â†’ CMakeLists.txt
       â†“
    [CMake]
       â†“
  [Ninja/Make]
       â†“
  *.elf / *.hex / *.bin
```

---

## âœ… å¿«é€Ÿæ£€æŸ¥æ¸…å•

- [x] ä¸»é“¾æ¥è„šæœ¬ä¸­å·²æ·»åŠ åˆå§‹åŒ–æ®µå®šä¹‰
- [ ] åœ¨ä»£ç ä¸­ä½¿ç”¨ `DF_BOARD_INIT()` ç­‰å®æ³¨å†Œåˆå§‹åŒ–å‡½æ•°
- [ ] è°ƒç”¨ `DF_INIT_AUTO_ENABLE()` æˆ–æ‰‹åŠ¨è°ƒç”¨ `DF_Framework_Init()`
- [ ] è¿è¡Œ `python tool/build.py` ç”Ÿæˆ CMakeLists.txt
- [ ] ç¼–è¯‘é¡¹ç›®
- [ ] æ£€æŸ¥ map æ–‡ä»¶ç¡®è®¤æ®µå­˜åœ¨
- [ ] è¿è¡Œç¨‹åºéªŒè¯åˆå§‹åŒ–å‡½æ•°è¢«è°ƒç”¨

---

**æœ€åæ›´æ–°æ—¶é—´**ï¼š2026-01-02
**ç»´æŠ¤è€…**ï¼šktkuri
